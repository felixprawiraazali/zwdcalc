<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZWDS 13-Palace Responsive Sections without A3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" type="text/css" href="./css/style.css">
</head>
<body class="bg-gray-100 text-gray-600">
  <div class="max-w-4xl mx-auto p-6 space-y-8">
	<!-- Form -->
	<form id="chartForm" class="bg-white p-6 rounded-lg shadow space-y-6">
	  <h2 class="text-2xl font-semibold">Plot Zi Wei Dou Shu Chart</h2>

	  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
		<!-- Name -->
		<div>
		  <label class="block font-medium">Name</label>
		  <input id="name" name="name" type="text"
				 class="mt-1 w-full border rounded p-2"
				 placeholder="e.g. Felix Prawira">
		</div>

		<!-- Birth Date -->
		<div class="space-y-1">
		  <label class="block font-medium">Birth Date</label>
		  <div class="flex gap-2">
			<input id="year"  name="year"  type="number" placeholder="YYYY" class="w-1/3 border rounded p-2">
			<input id="month" name="month" type="number" placeholder="MM"   class="w-1/3 border rounded p-2">
			<input id="day"   name="day"   type="number" placeholder="DD"   class="w-1/3 border rounded p-2">
		  </div>
		</div>

		<!-- Birth Time -->
		<div class="space-y-1">
		  <label class="block font-medium">Birth Time</label>
		  <div class="flex gap-2">
			<input id="hour"   name="hour"   type="number" placeholder="HH" class="w-1/2 border rounded p-2">
			<input id="minute" name="minute" type="number" placeholder="MM" class="w-1/2 border rounded p-2">
		  </div>
		</div>

		<!-- Gender -->
		<div>
		  <label class="block font-medium">Gender</label>
		  <div class="mt-1 flex gap-4">
			<label><input type="radio" name="gender" value="male"> Male</label>
			<label><input type="radio" name="gender" value="female"> Female</label>
		  </div>
		</div>        
	  </div>

	  <button type="submit"
			  class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
		Plot Chart
	  </button>
	</form>

	  <div class="zwds-grid">
		<template id="palace-template">
		  <div class="sectionA">
			<div class="sectionA1"></div>
			<div class="sectionA2"></div>
		  </div>
		  <div class="sectionB">
			<div class="sectionB1">
			  <div class="sectionB1-1"></div>
			  <div class="sectionB1-2"></div>
			</div>
			<div class="sectionB2">
			  <div class="sectionB2-1"></div>
			  <div class="sectionB2-2"></div>
			</div>
			<div class="sectionB3">
			  <div class="sectionB3-1"></div>
			  <div class="sectionB3-2"></div>
			</div>
		  </div>
		</template>
	  </div>	
  </div>


	<script src="./js/iztro.js"></script>
	<script src="./js/stars_mapping.js"></script>
	<script src="./js/hs_transformation.js"></script>
	<script src="./js/self_transformation.js"></script>
	<script>
		const labelMapping = ["L", "Q", "K", "J"]
		const labelColors = {
		  "L": "green",
		  "Q": "blue",
		  "K": "orange",
		  "J": "red"
		}

		function parseQuery() {
			return Object.fromEntries(new URLSearchParams(window.location.search));
		}

		function fillForm(params) {
			for (let key of ['name','year','month','day','hour','minute','location','latitude','longitude']) {
				if (params[key]) {
					document.getElementById(key).value = params[key];
				}
			}
			if (params.gender) {
				document.querySelector(`input[name="gender"][value="${params.gender}"]`)?.click();
			}
		}

		function capitalizeFirstLetter(str) {
			return str.charAt(0).toUpperCase() + str.slice(1);
		}

		function toChineseHourIndex(t) {
		  let h;
		  if (t instanceof Date) {
		    h = t.getHours();
		  } else if (typeof t === 'string') {
		    h = parseInt(t.split(':', 1)[0], 10);
		  } else {
		    h = Number(t);
		  }
		  if (h === 0)   return 0;                 // 00:00–00:59 → late Rat
		  if (h === 23)  return 12;                  // 23:00–23:59 → early Rat
		  // 01–22 → floor((h+1)/2) gives 1…11
		  
		  return Math.floor((h + 1) / 2);
		}

		function getAgesInRange(origAges, min, max) {
			// make a copy so we don’t clobber the original
			const allAges = [...origAges];
			// find those already in range
			let inRange = allAges.filter(age => age >= min && age <= max);

			// if none, keep adding 12 to the highest until one falls in range
			if (inRange.length === 0) {
				let highest = Math.max(...allAges);
				// loop until highest is within [min, max]
				if (max > highest) {
		      // keep bumping by 12 until we reach at least min
		      while (highest < min) {
		        highest += 12;
		        allAges.push(highest);
		      }
		      // re-filter now that we’ve added new data
		      inRange = allAges.filter(age => age >= min && age <= max);
		    }
			}

			return inRange;
		}

		const isWithinRange = (val, min, max) => val >= min && val <= max;

		const astro = iztro.astro 

		let defaultIndex = 5
		let indexMap = [3,4,5,6,2,7,1,8,0,11,10,9]
		let astrolabe = null

  	function generateChart(params) {
			let dob = params.year+'-'+params.month+'-'+params.day
			let timing = params.hour+':'+params.minute
			
			astrolabe = astro.bySolar(dob, toChineseHourIndex(timing), params.gender, true, 'en-US');
			let data = JSON.stringify(astrolabe, null, 1)
			// console.log(data)
			let currentYear = new Date().getFullYear()

			let currentAge = parseInt(currentYear) - parseInt(params.year) + 1

			let chineseYear = astrolabe.chineseDate.split(' - ')[0]
			let [heavenlyStem, startingPoint] = chineseYear.split(' ')

			let stars_transformation = transformations[heavenlyStem]
			
			let startFrom = 0
			let direction = 'clockwise'

			const container = document.querySelector('.zwds-grid');
			const tpl = document.getElementById('palace-template').content;

			const contextMenu = document.createElement('div');
			contextMenu.id = 'custom-menu';
			contextMenu.innerHTML = '<div id="transform-option">Transform Decade</div>';
			document.body.appendChild(contextMenu);

			// Hide menu when clicking outside
			document.addEventListener('click', () => {
				contextMenu.style.display = 'none';
			});

			for (let i = 0; i <= 11; i++) {
				let astroData = astrolabe.palaces[indexMap[i]]
				const cell = document.createElement('div');
				cell.className = 'p' + i;
				cell.dataset.palace = i;
				const clone = tpl.cloneNode(true);
				let [min, max] = astroData.decadal.range;

				if (isWithinRange(currentAge, min, max)) {
					defaultIndex = i					
				}
				if (astroData.earthlyBranch == startingPoint) {
					startFrom = i
					if (astroData.ages[0] > astrolabe.palaces[indexMap[i]+1 == 12 ? 0 : indexMap[i] + 1].ages[0]) {
						direction = 'counter-clockwise'
					}
				}

				let major = astroData.majorStars.filter(star => onlyShowStars().includes(star.name))
				let minor = astroData.minorStars.filter(star => onlyShowStars().includes(star.name))

				let enMajor = major.map(mj => stars.find(star => star.en === mj.name) ?? '')
				let enMinor = minor.map(mn => stars.find(star => star.en === mn.name) ?? '')

				let zhMajor = major.map(mj => stars.find(star => star.en === mj.name).zh ?? '')
				let zhMinor = minor.map(mn => stars.find(star => star.en === mn.name).zh ?? '')

				const markedNames = enMajor.map(e => {
		      const matched = stars_transformation
		        .map((word, index) => new RegExp(`\\b${word}\\b`, 'i').test(e.en) ? index : null)
		        .filter(i => i !== null);

		      const heavenly_transformation = matched.length > 0
				    ? ` ${matched.map(i => `<label style="color: ${labelColors[labelMapping[i]]};">[${labelMapping[i]}]</label>`).join(", ")}`
				    : '';

				  const self_transformation = (() => {
					  const st = getTransformationTypeWithArrow(astroData.decadal.heavenlyStem, e.key);
					  return st ? ` <label style="color: ${labelColors[st]};">${st}↑</label>` : "";
					})();

		      return `<span class="major">${e.en}${heavenly_transformation}${self_transformation}</span>`;
		    }).join('');
							
				clone.querySelector('.sectionA1').innerHTML = `
					${markedNames} 
					${enMinor.map(e => `<span class="minor">${e.en}</span>`).join('')}
				`;
				clone.querySelector('.sectionA2').innerHTML = `
					${zhMajor.map(e => `<span class="major">${e}</span>`).join('')} 
					${zhMinor.map(e => `<span class="minor">${e}</span>`).join('')}
				`;
				clone.querySelector('.sectionB1-1').textContent = capitalizeFirstLetter(astroData.heavenlyStem)
				clone.querySelector('.sectionB1-2').textContent = capitalizeFirstLetter(astroData.earthlyBranch)
				clone.querySelector('.sectionB2-1').textContent = '';
				clone.querySelector('.sectionB2-2').textContent = '';
				clone.querySelector('.sectionB3-1').textContent = capitalizeFirstLetter(astroData.name)
				clone.querySelector('.sectionB3-2').textContent = astroData.decadal.range.join('-')

        cell.addEventListener('contextmenu', function (event) {
					event.preventDefault();
					contextMenu.style.display = 'block';
					contextMenu.style.left = event.pageX + 'px';
					contextMenu.style.top = event.pageY + 'px';
					contextMenu.dataset.palaceIndex = i; // Store the index for use on click
				});
				cell.appendChild(clone);
				container.appendChild(cell);

			}
			
			for (let i = 0; i <= 11; i++) {
				let astroData = astrolabe.palaces[indexMap[i]]
				if (i == startFrom) {
					astrolabe.palaces[indexMap[i]].ages = []
					let j = -11
					while (astrolabe.palaces[indexMap[i]].ages.length < 10) {
						j += 12
						astrolabe.palaces[indexMap[i]].ages.push(j)
					}
				} else {
					let distance = 0
					if (direction == 'clockwise') {
						let astroStart = indexMap[startFrom]
						let astroCurrent = indexMap[i]
						distance = astroCurrent - astroStart
						if (astroCurrent < astroStart) {
							distance += 12
						}
					} else {
						let astroStart = indexMap[startFrom]
						let astroCurrent = indexMap[i]
						distance = astroStart - astroCurrent
						if (distance < 0) {
							distance += 12
						}						
					}

					astrolabe.palaces[indexMap[i]].ages = []
					let j = -11 + distance
					
					while (astrolabe.palaces[indexMap[i]].ages.length < 10) {
						j = j + 12
						
						astrolabe.palaces[indexMap[i]].ages.push(j)
					}
				}
			}

			document.getElementById('transform-option').addEventListener('click', function () {
				const palaceIndex = contextMenu.dataset.palaceIndex;				
				setPalaceAge(palaceIndex)
				contextMenu.style.display = 'none';
			});
			
			const center = document.createElement('div');
			center.className = 'p13';

			const leftDiv = document.createElement('div');
			leftDiv.style.width = '40%';
			leftDiv.style.textAlign = 'left';
			leftDiv.className = 'left'
			leftDiv.innerHTML = `
				${params.name} <br>
				${astrolabe.solarDate} (${currentAge}) <br>
				${params.hour}:${params.minute} ${astrolabe.time}
			`;

			const rightDiv = document.createElement('div');
			rightDiv.style.width = '40%';
			rightDiv.style.textAlign = 'right';
			rightDiv.className = 'right'
			rightDiv.innerHTML = ``;

			center.appendChild(leftDiv);
			center.appendChild(rightDiv);
			container.appendChild(center);

			setPalaceAge()
		}

		function onlyShowStars() {
			return [
				"Zi Wei",
				"Tian Ji",
				"Tai Yang",
				"Wu Qu",
				"Tian Tong",
				"Lian Zhen",
				"Tian Fu",
				"Tai Yin",
				"Tan Lang",
				"Ju Men",
				"Tian Xiang",
				"Tian Liang",
				"Qi Sha",
				"Po Jun",
				"Zuo Fu",
				"You Bi",
				"Wen Chang",
				"Wen Qu",
			]
		}

		function setPalaceAge(p = null) {
			if (p == null) {
				p = defaultIndex
			}
			let indexSelectedPalace = indexMap[p]
			
			let selectedPalace = astrolabe.palaces[indexSelectedPalace]			
			let [min, max] = selectedPalace.decadal.range
			for (let i = 0; i < 12; i++) {
				let astroData = astrolabe.palaces[indexMap[i]]
			  let el = document.querySelector(`.zwds-grid .p${i}`);
			  el.classList.remove('selected')
			  if (i == p) {
			  	el.classList.add('selected')
			  	// console.log(JSON.stringify(astroData, true, 2))
			  }
			  let age = getAgesInRange(astroData.ages, min, max)
			  el.querySelector('.sectionB2-1').textContent = age
			  if (parseInt(age) > 0) {
			  	el.querySelector('.sectionB2-2').textContent = parseInt(age) + parseInt(astrolabe.rawDates.lunarDate.lunarYear) - 1
			  }
			}

			let el = document.querySelector(`.zwds-grid .p13 .right`);
			el.innerHTML = `Decade ${min} - ${max}`
		}

		function getTransformationTypeWithArrow(stemKey, starName) {			
		  const types = ["L", "Q", "K", "J"]; // Lu, Quan, Ke, Ji		  
		  const entry = self_transforms[stemKey+"Heavenly"];
		  if (!entry || !entry.mutagen) return null;

		  const index = entry.mutagen.indexOf(starName);
		  return index !== -1 ? `${types[index]}` : null;
		}

		document.addEventListener('DOMContentLoaded', () => {
			const params = parseQuery();
			fillForm(params);

			// If URL has enough to plot, auto-draw:
			if (params.year && params.month && params.day) {
				generateChart(params);
			}

			// On form submit → reload with new query string
			document.getElementById('chartForm').addEventListener('submit', e => {
				e.preventDefault();
				const form = new FormData(e.target);
				const qs = new URLSearchParams(form).toString();
				window.location.search = qs;
			});
		});
	</script>
</body>
</html>